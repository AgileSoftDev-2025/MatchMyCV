{% load static %}
<div id="overlay" class="fixed inset-0 bg-black/50 z-30 hidden" onclick="closeSidebar()"></div>

<aside id="sidebar"
  class="fixed top-0 left-0 z-40 h-screen w-3/4 max-w-[300px] bg-white shadow-md -translate-x-full transition-transform duration-300 p-6">
  <div class="flex items-center justify-between border-b border-slate-200 pb-4 mb-4">
    <img src="{% static 'images/Logo MatchMyCV.png' %}" alt="Logo MatchMyCV" class="h-14">
    <button class="w-8 h-8 grid place-items-center text-slate-500 hover:text-slate-700" onclick="closeSidebar()">Ã—</button>
  </div>

  <div class="relative border-b border-slate-200 pb-4 mb-4">
    <button id="side-user-btn"
            class="flex items-center gap-3 w-full text-left hover:bg-slate-50 px-2 py-2 rounded-md">
      <svg class="w-10 h-10 text-slate-600 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M20 21a8 8 0 0 0-16 0"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <div class="min-w-0">
        <div class="text-sm font-semibold text-slate-900 truncate">
          {{ user.username|default:"User" }}
        </div>
        <div class="text-xs text-slate-500 truncate">
          {{ user.email|default:"user@example.com" }}
        </div>
      </div>
      <svg class="ml-auto w-4 h-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>

    <div id="side-user-panel"
         class="hidden mt-3 rounded-lg border border-slate-200 bg-white shadow-sm p-4">
      <div class="text-sm">
        <div class="font-semibold text-slate-900">
          {{ user.username|default:"User" }}
        </div>
        <div class="text-slate-600 break-all">
          {{ user.email|default:"user@example.com" }}
        </div>
      </div>
      <div class="mt-3">
        <a href="/logout/"
           class="inline-flex items-center justify-center w-full px-3 py-2 rounded-md text-sm font-medium
                  bg-slate-800 text-white hover:bg-slate-900">
          Logout
        </a>
      </div>
    </div>
  </div>

  <nav class="flex flex-col">
    <a href="/" class="px-4 py-3 rounded-md text-slate-500 hover:bg-slate-100">Home</a>
    <a href="/analisis-cv/" class="px-4 py-3 rounded-md text-slate-500 hover:bg-slate-100">Analyze CV</a>
    <a href="/tentang-kami/" class="px-4 py-3 rounded-md text-slate-500 hover:bg-slate-100">About Us</a>
    <a href="/faq/" class="px-4 py-3 rounded-md text-slate-500 hover:bg-slate-100">FAQ</a>
    <a href="/logout/" class="px-4 py-3 rounded-md text-slate-500 hover:bg-slate-100">Logout</a>
  </nav>
</aside>

<header class="sticky top-0 z-20 bg-white border-b border-slate-200">
  <div class="h-18 md:h-18 flex items-center justify-between px-4 md:px-8" style="height: 4.5rem;">
    <div class="flex items-center gap-4">
      <button id="hamburger"
              class="flex md:hidden flex-col gap-1.5 w-6"
              onclick="toggleSidebar()"
              aria-label="Toggle menu">
        <span class="h-0.5 w-full bg-slate-500 rounded transition-all"></span>
        <span class="h-0.5 w-full bg-slate-500 rounded transition-all"></span>
        <span class="h-0.5 w-full bg-slate-500 rounded transition-all"></span>
      </button>

      <a href="/" class="block">
        <img src="{% static 'images/Logo MatchMyCV.png' %}" alt="Logo MatchMyCV" class="h-14">
      </a>
    </div>

    <nav class="hidden md:flex items-center gap-7">
      <a href="/" class="text-[15px] font-regular hover:font-medium active:font-medium text-slate-500 hover:text-blue-600">Home</a>
      <a href="/analisis-cv/" class="text-[15px] font-regular hover:font-medium active:font-medium text-slate-500 hover:text-blue-600">Analyze CV</a>
      <a href="/tentang-kami/" class="text-[15px] font-regular hover:font-medium active:font-medium text-slate-500 hover:text-blue-600">About Us</a>
      <a href="/faq/" class="text-[15px] font-regular hover:font-medium active:font-medium text-slate-500 hover:text-blue-600">FAQ</a>
      <div class="relative">
        <button id="user-menu-button"
                class="w-9 h-9 grid place-items-center rounded-full border-2 border-slate-200 hover:bg-slate-50"
                aria-haspopup="menu" aria-expanded="false">
          <svg class="w-5 h-5 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M20 21a8 8 0 0 0-16 0"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </button>

        <div id="user-menu"
             class="hidden absolute right-0 mt-2 w-64 rounded-lg border border-slate-200 bg-white shadow-lg p-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 grid place-items-center rounded-full bg-slate-100 text-slate-600">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21a8 8 0 0 0-16 0"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold text-slate-900 truncate">
                {{ user.username|default:"User" }}
              </div>
              <div class="text-sm text-slate-600 break-all">
                {{ user.email|default:"user@example.com" }}
              </div>
            </div>
          </div>
          <div class="mt-4">
            <a href="/logout/"
               class="inline-flex items-center justify-center w-full px-3 py-2 rounded-md text-sm font-medium
                      bg-slate-800 text-white hover:bg-slate-900">
              Logout
            </a>
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>

<script>
  window.HeaderInit = function () {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const burger  = document.getElementById('hamburger');

    window.toggleSidebar = function () {
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
      if (!burger) return;
      burger.classList.toggle('open');
      const [l1, l2, l3] = burger.querySelectorAll('span');
      if (burger.classList.contains('open')) {
        l1.style.transform = 'translateY(6px) rotate(45deg)';
        l2.style.opacity = '0';
        l3.style.transform = 'translateY(-6px) rotate(-45deg)';
      } else {
        l1.style.transform = '';
        l2.style.opacity = '';
        l3.style.transform = '';
      }
    };

    window.closeSidebar = function () {
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
      if (!burger) return;
      const [l1, l2, l3] = burger.querySelectorAll('span');
      burger.classList.remove('open');
      l1.style.transform = '';
      l2.style.opacity = '';
      l3.style.transform = '';
    };

    function norm(p){ return (p || '/').replace(/\/+$/,'/') || '/'; }
    const current = norm(window.location.pathname);
    document.querySelectorAll('header a[href], aside a[href]').forEach(a => {
      if (norm(a.getAttribute('href')) === current) {
        a.classList.add('text-blue-600','font-bold');
        if (a.closest('aside')) a.classList.add('bg-slate-100');
      }
    });

    // User dropdown (navbar)
    const userBtn   = document.getElementById('user-menu-button');
    const userMenu  = document.getElementById('user-menu');
    // User panel (sidebar)
    const sideUserBtn   = document.getElementById('side-user-btn');
    const sideUserPanel = document.getElementById('side-user-panel');

    function hideAllUserMenus() {
      userMenu?.classList.add('hidden');
      sideUserPanel?.classList.add('hidden');
      userBtn?.setAttribute('aria-expanded', 'false');
    }

    userBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      sideUserPanel?.classList.add('hidden');
      userMenu.classList.toggle('hidden');
      userBtn.setAttribute('aria-expanded', userMenu.classList.contains('hidden') ? 'false' : 'true');
    });

    sideUserBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenu?.classList.add('hidden');
      sideUserPanel.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      const withinNavbar  = userBtn?.contains(e.target) || userMenu?.contains(e.target);
      const withinSidebar = sideUserBtn?.contains(e.target) || sideUserPanel?.contains(e.target);
      if (!withinNavbar && !withinSidebar) hideAllUserMenus();
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideAllUserMenus(); });
  };
</script>
