{% extends "base.html" %}
{% load static %}

{% block title %}MatchMyCV · Analisis CV{% endblock %}

{% block extra_head %}
<style>
  .modal-backdrop { 
    position: fixed; 
    inset: 0; 
    background: rgba(2,6,23,0.4); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 50; 
  }
  .modal { 
    background: white; 
    border-radius: 12px; 
    max-width: 560px; 
    width: 95%; 
    padding: 20px; 
    box-shadow: 0 8px 30px rgba(2,6,23,0.12); 
  }
  .hidden { display: none; }
  .visible { display: block; }
  .form-message { 
    margin-top: 0.75rem; 
    color: #dc2626; 
    font-weight: 600; 
  }
  .success-message { 
    color: #059669; 
    font-weight: 600; 
  }
  /* GIF styling for loading screen */
  .loading-gif {
    width: 10rem; /* 160px */
    max-width: 40%;
    height: auto;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  @media (min-width: 768px) {
    .loading-gif { width: 12rem; }
  }
</style>
{% endblock %}

{% block content %}
<section id="page-header" class="pt-20 pb-10">
  <div class="text-center px-4">
    <h1 class="text-3xl md:text-4xl font-extrabold text-[#2D63B0] mb-2">Match Your CV</h1>
    <p class="text-slate-600 text-lg">Find the best job matches for your CV instantly.</p>
  </div>
</section>

<section class="pb-16">
  <div class="max-w-[56.25rem] mx-auto px-6">
    <div id="form-container">
      <div class="mb-8">
        <label for="location" class="block text-slate-900 font-semibold mb-3">Location</label>
        <select id="location" class="form-select w-full py-3.5 px-4 border rounded pr-10">
          <option value="all">All Locations</option>
          <option value="jakarta">Jakarta</option>
          <option value="surabaya">Surabaya</option>
          <option value="bandung">Bandung</option>
          <option value="yogyakarta">Yogyakarta</option>
        </select>
      </div>

      <!-- Upload Section -->
      <div class="flex flex-col items-center">
        <!-- Hidden native file input -->
        <input type="file" id="cv-upload" accept=".pdf" class="hidden" data-testid="cv-upload">
        <button type="button" id="upload-btn" class="bg-blue-600 text-white py-3 px-8 rounded font-semibold mb-3">
          Upload CV
        </button>
      </div>

      <!-- Modal -->
      <div id="uploadCvModal" class="modal-backdrop" aria-hidden="true">
        <div class="modal">
          <h3 class="text-lg font-bold mb-3">Upload CV</h3>
          <p class="text-sm text-slate-600 mb-4">Supported format: PDF (max. 10 MB)</p>

          <div class="mb-4">
            <label class="block text-sm mb-2">Choose file</label>
            <div class="flex gap-3 items-center">
              <button type="button" id="choose-file-btn" class="px-4 py-2 bg-slate-100 border rounded">Choose File</button>
              <div>
                <div id="display-filename" class="text-slate-900 font-semibold text-sm">No file chosen</div>
                <div id="display-filesize" class="text-slate-500 text-xs">—</div>
              </div>
            </div>
          </div>

          <div id="form-message" class="form-message hidden" role="alert"></div>

          <div class="flex justify-end gap-3 mt-4">
            <button type="button" id="close-modal" class="px-4 py-2 rounded border">Cancel</button>
            <button type="button" id="analyze-btn" class="px-4 py-2 rounded bg-blue-600 text-white">Analyze</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Container -->
    <div id="loading-container" class="hidden pt-20">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-[#2D63B0] mb-3">Analyzing CV</h1>
        <p class="text-slate-600 text-base" id="loading-filename">My CV.pdf (3.5 MB)</p>
      </div>

      <!-- Animated GIF (place under static/images/loading.gif) -->
      <div class="max-w-4xl mx-auto mb-8 text-center">
        <img id="loading-gif" class="loading-gif" src="{% static 'images/loading.gif' %}" alt="Loading animation" />
      </div>

      <div class="max-w-4xl mx-auto mb-8">
        <div class="bg-slate-200 rounded-full h-8 overflow-hidden">
          <div id="progress-bar" class="bg-blue-600 h-full rounded-full" style="width:0%"></div>
        </div>
      </div>
      <div class="text-center">
        <p id="progress-percent" class="text-4xl font-bold text-blue-600 mb-2">0%</p>
        <p id="progress-status" class="text-lg text-slate-600">Analyzed</p>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const els = {
    fileInput: document.getElementById('cv-upload'),
    uploadBtn: document.getElementById('upload-btn'),
    modalBackdrop: document.getElementById('uploadCvModal'),
    chooseFileBtn: document.getElementById('choose-file-btn'),
    closeModalBtn: document.getElementById('close-modal'),
    displayFilename: document.getElementById('display-filename'),
    displayFilesize: document.getElementById('display-filesize'),
    formMessage: document.getElementById('form-message'),
    analyzeBtn: document.getElementById('analyze-btn'),
    loadingContainer: document.getElementById('loading-container'),
    pageHeader: document.getElementById('page-header'),
    formContainer: document.getElementById('form-container'),
    progressBar: document.getElementById('progress-bar'),
    progressPercent: document.getElementById('progress-percent'),
    progressStatus: document.getElementById('progress-status'),
    loadingFilename: document.getElementById('loading-filename'),
    locationSelect: document.getElementById('location'),
    loadingGif: document.getElementById('loading-gif')
  };

  let uploadedFile = null;

  function showModal() {
    els.modalBackdrop.style.display = 'flex';
    els.modalBackdrop.setAttribute('aria-hidden', 'false');
    els.formMessage.classList.add('hidden');
    els.formMessage.textContent = '';
  }

  function hideModal() {
    els.modalBackdrop.style.display = 'none';
    els.modalBackdrop.setAttribute('aria-hidden', 'true');
  }

  function showError(message) {
    els.formMessage.textContent = message;
    els.formMessage.classList.remove('hidden');
    els.formMessage.classList.remove('success-message');
    els.formMessage.classList.add('form-message');
    // Expose to window for testing
    window.lastErrorMessage = message;
  }

  function showSuccess(message) {
    els.formMessage.textContent = message;
    els.formMessage.classList.remove('hidden');
    els.formMessage.classList.remove('form-message');
    els.formMessage.classList.add('success-message');
  }

  // Open modal when Upload CV clicked
  els.uploadBtn.addEventListener('click', (e) => {
    e.preventDefault();
    showModal();
  });

  // Choose file - trigger native input
  els.chooseFileBtn.addEventListener('click', function() {
    els.fileInput.click();
  });

  els.closeModalBtn.addEventListener('click', function() {
    hideModal();
  });

  // File validation on change
  els.fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Clear previous errors
    els.formMessage.classList.add('hidden');
    window.lastErrorMessage = null;

    // File size check (10MB = 10 * 1024 * 1024 bytes)
    if (file.size > 10 * 1024 * 1024) {
      showError('Ukuran file melebihi batas maksimum (10MB)!');
      uploadedFile = null;
      els.displayFilename.textContent = 'No file chosen';
      els.displayFilesize.textContent = '—';
      els.fileInput.value = ''; // Reset input
      return;
    }

    // MIME type check
    const fileType = file.type || '';
    const isPdfExt = file.name.toLowerCase().endsWith('.pdf');

    if (fileType !== 'application/pdf' && !isPdfExt) {
      showError('Format file tidak valid, silakan unggah file PDF!');
      uploadedFile = null;
      els.displayFilename.textContent = 'No file chosen';
      els.displayFilesize.textContent = '—';
      els.fileInput.value = ''; // Reset input
      return;
    }

    // File is valid
    uploadedFile = file;
    els.displayFilename.textContent = file.name;
    els.displayFilesize.textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB`;
    
    // Expose to window for testing
    window.uploadedFile = file;
  });

  // Start analysis
  async function startAnalysis() {
    if (!uploadedFile) {
      showError('Silakan pilih file PDF terlebih dahulu.');
      return;
    }

    // Hide modal and form, show loading
    hideModal();
    els.pageHeader.classList.add('hidden');
    els.formContainer.classList.add('hidden');
    els.loadingContainer.classList.remove('hidden');

    // Ensure GIF is visible (if it exists) for better UX
    if (els.loadingGif) els.loadingGif.style.display = 'block';

    const filesizeText = `${(uploadedFile.size / 1024 / 1024).toFixed(1)} MB`;
    els.loadingFilename.textContent = `${uploadedFile.name} (${filesizeText})`;

    // Animated progress
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress > 90) progress = 90;
      els.progressBar.style.width = `${Math.floor(progress)}%`;
      els.progressPercent.textContent = `${Math.floor(progress)}%`;

      // optional nice touch: update small status text while waiting
      const statusPhrases = ['Parsing content...', 'Extracting skills...', 'Matching to jobs...', 'Finalizing results...'];
      const idx = Math.min(Math.floor(progress / 25), statusPhrases.length - 1);
      els.progressStatus.textContent = statusPhrases[idx];
    }, 300);

    const formData = new FormData();
    formData.append('cv_file', uploadedFile);
    formData.append('location', els.locationSelect.value);

    try {
      const resp = await fetch('/api/analyze-cv/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      const result = await resp.json();

      clearInterval(interval);

      if (result && result.success) {
        els.progressBar.style.width = '100%';
        els.progressPercent.textContent = '100%';
        els.progressStatus.textContent = 'Analysis Complete!';
        
        // Hide GIF once finished (keeps transition smooth)
        if (els.loadingGif) els.loadingGif.style.display = 'none';

        // Store results
        sessionStorage.setItem('cv_analysis_results', JSON.stringify(result));
        
        // Redirect after short pause so user sees 100%
        setTimeout(() => {
          window.location.href = '/hasil-rekomendasi/';
        }, 600);
      } else {
        clearInterval(interval);
        const errorText = (result && result.error) ? result.error : 'Analysis failed';
        alert(errorText);
        // Reset to form
        els.pageHeader.classList.remove('hidden');
        els.formContainer.classList.remove('hidden');
        els.loadingContainer.classList.add('hidden');
      }
    } catch (err) {
      clearInterval(interval);
      alert(err.message || 'Network error');
      els.pageHeader.classList.remove('hidden');
      els.formContainer.classList.remove('hidden');
      els.loadingContainer.classList.add('hidden');
    }
  }

  els.analyzeBtn.addEventListener('click', function() {
    startAnalysis();
  });

  // Close modal on backdrop click
  document.getElementById('uploadCvModal').addEventListener('click', function(e) {
    if (e.target === this) hideModal();
  });

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Expose functions for testing
  window.testHelpers = {
    getUploadedFile: () => uploadedFile,
    getLastError: () => window.lastErrorMessage,
    triggerFileChange: (file) => {
      const dt = new DataTransfer();
      dt.items.add(file);
      els.fileInput.files = dt.files;
      els.fileInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
  };
</script>
{% endblock %}
